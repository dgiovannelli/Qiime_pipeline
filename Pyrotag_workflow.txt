#Pyrotag 16S rRNA diversity analysis workflow by Donato Giovannelli - 2013
#This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License.
#Read the licence at http://creativecommons.org/licenses/by-sa/3.0/

This file describe the analysis of 16S rRNA sequences used 


Assumption:
- You successfully installed Qiime 1.5 - http://qiime.org/
- You downloaded and installed Topiary Explorer - http://topiaryexplorer.sourceforge.net/user_guide/install.html
- You have a text editor program capable of handling different file format such as Gedit - http://projects.gnome.org/gedit/
- You are working on a linux machine (or other unix systems) and are familiar with command line interface
- You have access to the relevant source file from the sequencing facility to perform the analysis


NOTES: 
This analysis is carried out starting from the output of Mr.DNA (http://www.mrdnalab.com/) sequencing facility. You may need to find complementary files results obtained by your sequencing service.

Objectives:
- Analyse total diversity in your sample(s)
- Identify difference among samples
- Plot publication ready images of the diversity
- Plot publication ready trees of the diversity


Workflow:
- Identify in your source file the .fasta file containing the sequences denoised, demultiplexed and quality checked and the mapping file. For Mr.CNA the file is in the folder projectname/fasta-qual-mapping-files/ and is usually named projectname-pr.fasta and the mapping is projectname-mapping2.txt.
- Make a copy of those files in you new working directory (I will refer to this directory as WORK/ from now on) and rename the mapping file to map.txt
- Open the file you present in WORK/ with the text editor (Gedit) and substitute in all the file the "::" between the samplesID and the sequence name with "_" without the quotes. Mr.DNA facilities use "::" to separate sampleID from sequence name but this will conflict with Qiime. Save the new file as projectname-pr_mod.fasta
- At this step you may wont to analyse all the sequences present in your file or only a sub set. In case you need to split the sequences you can use the following command:

split_fasta_on_sample_ids.py -i projectname-pr_mod.fasta -o split/
or
extract_seqs_by_sample_id.py -i projectname-pr_mod.fasta -o outseqs.fasta -s SAMPLEID

The former will divide the sequences by sampleID, the latter will save in the output file (-o) only the sequences associated with a specific sampleID (-s) separated by comma.
- In any case put the final sequences (from the splitting) or all the sequences (from the projectname-pr_mod.fasta) into a new fasta formatted file called seq.fna.
- Copy in WORK/ the two analysis file qiime_analysis_multi.sh and Results.html.
- Open a terminal, move into WORK/ and run the default qiime pipeline from D. Giovannelli typing:

./qiime_analysis_multi.sh

or change the internal parameters before the run where necessary. In order to get the biodiversity assigned to genus level you need to install the GreenGenes genus level (https://groups.google.com/forum/?fromgroups=#!topic/qiime-forum/ISXDpbC45xg) and substitute the file in the qiime installation with the default one (see https://groups.google.com/forum/?fromgroups=#!topic/qiime-forum/yVCLCzBLfaw for clarification; in general I usually rename the new file as the older one after making a backup copy of both). 
- Once the analysis is completed check the Results.html file by opening it with Firefox (or equivalent). You will find there the library summary, the plots and the tree in newick format to download for further use.
- Download the intended images and legends by saving the plot in .pdf format following the link above each plot. Open the image with a vector image manipulation program and modify the image according to publication needs. I use the freely available crossplatform Inkscape (http://inkscape.org/).

NB:The following three operations are now included into the qiime_analysis_multi.sh script and performed automatically
- In order to produce taxonomy informed diversity trees you will need the following files: tree_newick.txt, tip_data.txt, OTU_table.txt and sample_data.txt. Create inside WORK/ a new folder named TREE/ and copy into this folder (beware to copy and NOT move those files) the following four files:
otus/rep_set_cc.tre
otus/rdp_assigned_taxonomy/seq_rep_set_tax_assignments.txt
otus/otu_table_cc.biom
map.txt

- Rename the first two as rep_set_cc.txt and tip_data.txt respectively
- From the terminal enter the WORK/TREE/ directory and run:

convert_biom.py -i otu_table_cc.biom -o otu_table.txt -b --header_key taxonomy --output_metadata_id "Consensus Lineage" 

to convert the .biom OTu table into a tab separated OTu table.
- Modify the tip_data.txt file to exclude the second and eventually last column and include tab separated header (#OTU_ID	Grenngenes_consensus	etc...)

Topiary Explorer:
- Run the Topiary Explorer program using the manufacturer instructions.
- Start a new project by loading each of the four file into the appropriate place.
- Color branches according to samplesID, Description or Greengenes taxonomy respectively
- Label tips according to samplesID, Description or Greengenes taxonomy respectively as needed
- Set consensus phylogeny and collapse tree to get the desired level of visualization
- Export the tree as single .pdf file to be modified into Inkscape, or start the batch_exporter to get a tree for each individual color scheme.


 
