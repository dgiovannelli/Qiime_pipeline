QIIME SINGLE SAMPLE ANALYSIS
Donato Giovannelli - 2012
/-------------------------------------------------------------------------/
README file for the single sample (demultiplexed) anlysis pipeline of
 16S PyroTag sequences with QIIME 1.5. The QIIME script and this readme were written by
Donato Giovannelli at the Deep Sea Microbiology Lab, IMCS, Rutgers University, NJ, USA.
/-------------------------------------------------------------------------/



CONTENT
-----------------------------------
- AUUMPTION
- ANALYSIS IN BRIEF
- INPUT FILE REQUIREMENT
- RUNNING THE ANALYSIS
- OUTPUT FILES AND RESULTS
- TROUBLESHOOTING



ASSUMPTION
-----------------------------------
The following readme file and QIIME analysis script makes the following assumption:
- your sequence file is in fasta format.
- your sequences have already been separated from other samples (demultiplexed), trimmed
of the primer and quality checked. Usually the sequencing facility does this operations
with no additional costs. See INPUT FILE REQUIREMENT section for details.
- You have a sample name. In this example we will refer to it with SampleName.
- We will refer to your name in the following example as YourName.


THE ANALYSIS IN BRIEF
-----------------------------------
- Go into the VM data sharing folder on the desktop
- Create inside the folder a new folder named YourName_SampleName
- Copy inside the folder your sequence file, the map.txt file, the readme.txt and the 
qiime_analysis.sh file. IMPORTANT qiime.analysis.sh and readme.txt DO NOT HAVE TO BE 
MOVED TO THE FOLDER, BUT COPIED TO THE FOLDER. KEEP THE ORIGINAL ALWAYS IN THIS LOCATION.
- Fromat the sequence file and rename it seq.fna (see below)
- Format the map.txt changing the SampleName field with the actual name of your sample
- Open the VirtualBox machine and start QIIME
- Open a terminal and write
	cd Desktop/
	cd Shared_Folder/
	cd YourName_SampleName/	
	./qiime_analysis.sh
- At the end of the analysis close the virtual machine and access your results in 
YourName_SampleName folder
- HAPPY QIIMING!!!! ;) 



INPUT FILE REQUIREMENT
-----------------------------------
The input file required for the analysis are:

- seq.fna --> .fasta file containing the demultiplexed sequences formatted as described below
- map.txt --> tab separated txt file conteining the fake barcode map for demultiplexing (required by QIIME)

QIIME is expecting to have a fasta file containing your sequences which comprises multiple samples
separated by a barcode (tag) sequence and a primerLinker. The normal QIIME workflow use the barcode and 
primerLinker given in the map.txt file to assign to each group of sequences a sample specific name and
the downstream analyses all use the map.txt file to perform comparative analyses among samples.
This readme file and bash script were written to work with single samples file (demultiplexed). 
In order for QIIME to perform a correct analysis we need to properly format our dataset.

The average file containing sequence will look like:

>F7KXSUD02GAS69  source=Biofilm  length=144
CCCTCCCCGAAAGCTCCGGCGCCCGAGGATGGGGCTGCGGCGGATTAGGTAGGTTGGTGGGGTAACGGCCCACCAAGCCGACGATCCGTACGGGCCCTGAGAGGGGAGCCCGGAGATGGACACTGAGACACGGGTCCAGGCCCT
>F7KXSUD02IXWN5  source=Biofilm  length=265
CGCGCTCTGCGCGCACCGGCGGACGGCTCAGTAACACGTCGGTAACCTACCCTCGGGAGGGGGATAACCCCGGGAAACTGGGGCTAATCCCCCATAGGCCTGGGGTACTGGAAGGTCCCCAGGCCGAAAGGGGCTCTGCCCGCCCGAGGATGGGCCGGCGGCCGATTAGGTAGTTGGTGGGGTAACGGCCCACCAAGCCGAAGATCGGTACGGGCCATGAGAGTGGGAGCCCGGAGATGGACACTGAGACACGGGTCCAGGCCCT
>F7KXSUD02GB4C9  source=Biofilm  length=266
CGGCGCTCTGCGCGCACCGGCGGACGGCTCAGTAACACGTCGGTAACCTACCCTCGGGAGGGGGATAACCCCGGGAAACTGGGGCTAATCCCCCATAGGCCTGGGGTACTGGAAGGTCCCCAGGCCGAAAGGGGCTCTGCCCGCCCGAGGATGGGCCGGCGGCCGATTAGGTAGTTGGTGGGGTAACGGCCCACCAAGCCGAAGATCGGTACGGGCCATGAGAGTGGGAGCTCGGAGATGGACACTGAGACACGGGTCCAGGCCCT
>CV41 F7KXSUD02FHOF9  source=Biofilm  length=135
...

Where the F7KXSUD02G... is the sequence name. The formatting is a standard FASTA file, with the start 
of every sequence marked with > and the sequence strating after a new line (using enter/return key) was given. 
We can have as many space separated field in the first line of the header of each sequence as we want. 
Usually the more informations the better. In this example the fields 'source' and 'lenght' are present.
We need to format the file adding to the first line of every sequence the sample name followed by a progressive number
for every sequence separated by an underscore character (_). Usually this can be accomplished with excel or similar spreadsheet programs.
The final file has to be exported as a tab separated file and should look like this:

>SampleName_1	F7KXSUD02G4WM7	source=Biofilm	length=241
CTGGCGACCGGCGAACGGGTGAGTAACACGTAGCACTTGCCCTCCAGAGGGGGATAACCGGGGAAACCCGGGCTAATACCCCATACACCCGAGAGGGGAAAGGTTCAGCCGATAGGCTGTTCCGCTGCGGGATGGGGCTGCGGCCTATCAGCTAGTTGGTGGGGTAACGGCCTACCAAGGCGATGACGGGTAGCTGGCCTGAGAGGATGATCAGCCACACTGGGACTGAGACACGGCCCAG			
>SampleName_2	F7KXSUD02I9V8Z	source=Biofilm	length=121
AGCACTATGGGATGGGGCTGCGGCGTATCAGCTAGTTGGTGGGGTAAAGGCCTACCAAGGCTATGACGCGTAGCTGGTCTGAGAGGATGATCAGCCACACTGGAACTGAGACACGGTCCAG			
>SampleName_3	F7KXSUD02H72AH	source=Biofilm	length=219
CGCACGGGTGAGTAACACGTAGCTACCTGCCCCATAGACCGGGATAACAGCTGGAAACGGCTGCTAATACTGGATACTCCCTACGGGGGAAATGCTTTTGCGCTATGGGATGGGGCTGCGGCGTATCAGCTAGTTGGTAAGGTAACGGCTTATCAAGGCTATGACGCGTAGCTGGTCTGAGAGGATGATCAGCCACACTGGAACTGAGACACGGTCCAG			
>SampleName_4	F7KXSUD02IRJ57	source=Biofilm	length=243
...

Now lets move on the map.txt file. it needs to be modified in only two field. The SampleName field and the commnets 
field (optional). Be carefull to put the same SampleName in the seq.fna file and map.txt file. Be carefull to not
remove ampty spaces in the map.txt file! This will stop the analysis from working.

#SampleID	BarcodeSequence	LinkerPrimerSequence	Description
SampleName			Comments



RUNNING THE ANALYSIS
--------------------------------------
After formatting the seq.fna file and the map.txt file crate a folder called YourName_SampleName in the 
VM data sharing folder. Copy in the same location also this readme and the qiime_analysis.sh file. 
PLEASE DO NOT REMOVE THIS TWO FILE FROM THIR ORIGINAL LOCATION.
Coping the QIIME file will allow you to modify the script to suit your need and leave the original
for future analyses. Moreover you will have a reference of what you actually did during your analysis for
future result interpretation.

Start the VirtualBox and start the QIIME virtual machine. Once inside open the terminal (is the black icon 
on the left with a >_ sign.
Digit the following command to move into YouName_SampleName folder and strat the analysis. After every line
it enter:

	cd Desktop/
	cd Shared_Folder/
	cd YourName_SampleName/	
	./qiime_analysis.sh

Your analysis will require from 10 minutes to several hours to complete depending on sequence number.
The script will notify you the operation as their are implemented and the end of each analysis in the
terminal screen and with a notification pop-up in the top-right of your Virtul-Box screen.

At the end of the analysis close the Virtual-Box and access your results in the YouName_SampleName folder.



OUTPUT FILES AND RESULTS
---------------------------------------
QIIME will create in your folder several new fileas and folder. The content of same of them, generally the ones
of your interest is described below. Sometimes some file have two version, one of which will have a _cc part on 
its name. _cc stads for chimera cheked and should be the one you use for future analyses.


- check_map			FOLDER Contains the result of the map.txt check. Open the file map.html to see if any
error was ecuntered in your map. Errors are marked in red. Often the map_corrected.txt contain the correct version 
of your map. Substitute the original map.txt with the corrected one and change its name to map.txt. Re-run the analysis.

- output_plots			FOLDER Contains the bar.html and pie.html file containing the diversity plots at different phylogenetic
level (phylum, order, class, family) and the .pdf downlodable version of the figure that can be modified in Inkscape or
Illustrator.

- otus				FOLDER Contains the rep_set_cc.tre file with the newick phylogenetic tree of your OTUs. Inside 
this folder  there is also the otu_heatmap (smaple interactive heatmap) and the sequence alignment inside the
pynast_aligned_seqs (seq_rep_set_aligned_pfiltered_cc.fasta)

- alpha_rarefaction		FOLDER Contains the compute=d alpha diversity index and the rarefaction curve for your 
sample in the alpha_rarefaction_plots subfolder rarefaction_plots.html file

- library_summary_cc.txt	FILE Contains the summary of your chimera removed library

- rep_set/seq_rep_set_cc.fasta	FILE Contains the representative sequences of your OTUs with suspect chimera removed




TROUBLESHOOTING
-----------------------------------------
In case of no analysis result common problem are:

- seq.fna not correctly formatted
- map.txt not correctly formatted. Look for errors in the check_map folder

Contact me for further problem donato.giovannelli [at] gmail dot com














